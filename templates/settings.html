{% extends "base.html" %}

{% block title %}Settings - Audit Tracking System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white rounded-2xl shadow-2xl p-8 mb-8">
        <div class="flex items-center space-x-4">
            <div class="bg-white/20 p-4 rounded-xl backdrop-blur-sm">
                <i class="fas fa-cog text-3xl text-white"></i>
            </div>
            <div>
                <h1 class="text-4xl font-bold">Settings</h1>
                <p class="text-purple-100 text-lg">Manage your account preferences</p>
            </div>
        </div>
    </div>

    <!-- Navigation Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <a href="{{ url_for('index') }}" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </li>
            <li>
                <span class="text-gray-400">/</span>
            </li>
            <li class="text-gray-900 font-medium">Settings</li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Settings Menu -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b">
                    <h2 class="text-lg font-semibold text-gray-900">Account Settings</h2>
                </div>
                <div class="p-6">
                    <nav class="space-y-2">
                        <a href="#password" onclick="showSection('password')" class="settings-nav-item active flex items-center px-4 py-3 rounded-lg text-purple-700 bg-purple-50 border border-purple-200 transition-all duration-200">
                            <i class="fas fa-key mr-3"></i>
                            Change Password
                        </a>
                        <a href="#profile" onclick="showSection('profile')" class="settings-nav-item flex items-center px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-purple-700 border border-transparent hover:border-purple-200 transition-all duration-200">
                            <i class="fas fa-user mr-3"></i>
                            Profile Information
                        </a>
                        <a href="#security" onclick="showSection('security')" class="settings-nav-item flex items-center px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-purple-700 border border-transparent hover:border-purple-200 transition-all duration-200">
                            <i class="fas fa-shield-alt mr-3"></i>
                            Security Settings
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="lg:col-span-2">
            <!-- Change Password Section -->
            <div id="password-section" class="settings-section bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-key text-purple-600 mr-3"></i>
                        Change Password
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">Update your account password for better security</p>
                </div>
                <div class="p-6">
                    <form method="POST" class="space-y-6">
                        <!-- CSRF Protection -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Current Password -->
                        <div>
                            <label for="current_password" class="block text-sm font-medium text-gray-700 mb-2">
                                Current Password
                            </label>
                            <div class="relative">
                                <input type="password" 
                                       id="current_password" 
                                       name="current_password" 
                                       required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 pr-12"
                                       placeholder="Enter your current password">
                                <button type="button" 
                                        onclick="togglePassword('current_password')"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                                    <i class="fas fa-eye" id="current_password_icon"></i>
                                </button>
                            </div>
                        </div>

                        <!-- New Password -->
                        <div>
                            <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                                New Password
                            </label>
                            <div class="relative">
                                <input type="password" 
                                       id="new_password" 
                                       name="new_password" 
                                       required
                                       minlength="{{ password_requirements[user.role]['min_length'] }}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 pr-12"
                                       placeholder="Enter your new password"
                                       oninput="validatePassword()">>
                                <button type="button" 
                                        onclick="togglePassword('new_password')"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                                    <i class="fas fa-eye" id="new_password_icon"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <div class="space-y-1">
                                    <div id="length-check" class="flex items-center space-x-1">
                                        <i class="fas fa-times text-red-500 text-xs"></i>
                                        <span class="text-xs text-red-600">{{ password_requirements[user.role]['min_length'] }}+ characters</span>
                                    </div>
                                    {% if password_requirements[user.role]['require_uppercase'] %}
                                    <div id="uppercase-check" class="flex items-center space-x-1">
                                        <i class="fas fa-times text-red-500 text-xs"></i>
                                        <span class="text-xs text-red-600">Uppercase letter (A-Z)</span>
                                    </div>
                                    {% endif %}
                                    {% if password_requirements[user.role]['require_lowercase'] %}
                                    <div id="lowercase-check" class="flex items-center space-x-1">
                                        <i class="fas fa-times text-red-500 text-xs"></i>
                                        <span class="text-xs text-red-600">Lowercase letter (a-z)</span>
                                    </div>
                                    {% endif %}
                                    {% if password_requirements[user.role]['require_numbers'] %}
                                    <div id="numbers-check" class="flex items-center space-x-1">
                                        <i class="fas fa-times text-red-500 text-xs"></i>
                                        <span class="text-xs text-red-600">Number (0-9)</span>
                                    </div>
                                    {% endif %}
                                    {% if password_requirements[user.role]['require_special'] %}
                                    <div id="special-check" class="flex items-center space-x-1">
                                        <i class="fas fa-times text-red-500 text-xs"></i>
                                        <span class="text-xs text-red-600">Special character (!@#$%^&*)</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                                    <p class="text-xs text-blue-700">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>{{ user.role.title() }} Requirements:</strong> {{ password_requirements[user.role]['description'] }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Confirm Password -->
                        <div>
                            <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                                Confirm New Password
                            </label>
                            <div class="relative">
                                <input type="password" 
                                       id="confirm_password" 
                                       name="confirm_password" 
                                       required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 pr-12"
                                       placeholder="Confirm your new password">
                                <button type="button" 
                                        onclick="togglePassword('confirm_password')"
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                                    <i class="fas fa-eye" id="confirm_password_icon"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end space-x-4">
                            <button type="button" 
                                    onclick="document.getElementById('current_password').value=''; document.getElementById('new_password').value=''; document.getElementById('confirm_password').value='';"
                                    class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-200 font-medium">
                                Reset
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-200 font-medium shadow-lg hover:shadow-purple-500/25 hover:-translate-y-0.5">
                                <i class="fas fa-save mr-2"></i>
                                Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Profile Information Section -->
            <div id="profile-section" class="settings-section bg-white rounded-2xl shadow-xl overflow-hidden hidden">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-user text-blue-600 mr-3"></i>
                        Profile Information
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">View and manage your profile details</p>
                </div>
                <div class="p-6">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900">
                                {{ session.username }}
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Username cannot be changed</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
                            <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900">
                                Administrator
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Login</label>
                            <div class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900">
                                Current session
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings Section -->
            <div id="security-section" class="settings-section bg-white rounded-2xl shadow-xl overflow-hidden hidden">
                <div class="bg-gradient-to-r from-green-50 to-teal-50 px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-shield-alt text-green-600 mr-3"></i>
                        Security Settings
                    </h3>
                    <p class="text-sm text-gray-600 mt-1">Manage your account security preferences</p>
                </div>
                <div class="p-6">
                    <div class="space-y-6">
                        <div class="flex items-center justify-between p-4 border border-green-200 rounded-lg bg-green-50">
                            <div>
                                <h4 class="font-medium text-green-800">Concurrent Login Prevention</h4>
                                <p class="text-sm text-green-600">Only one active session allowed per user</p>
                            </div>
                            <div class="text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 border border-green-200 rounded-lg bg-green-50">
                            <div>
                                <h4 class="font-medium text-green-800">Activity Logging</h4>
                                <p class="text-sm text-green-600">All user actions are logged and monitored</p>
                            </div>
                            <div class="text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 border border-blue-200 rounded-lg bg-blue-50">
                            <div>
                                <h4 class="font-medium text-blue-800">Session Timeout</h4>
                                <p class="text-sm text-blue-600">Sessions expire after 7 days with "Remember Me"</p>
                            </div>
                            <div class="text-blue-600">
                                <i class="fas fa-info-circle text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="{{ url_for('activity_logs') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-green-700 bg-green-100 hover:bg-green-200 transition-all duration-200">
                                <i class="fas fa-history mr-2"></i>
                                View Activity Logs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="mt-8 flex justify-center">
        <a href="{{ url_for('index') }}" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-purple-600 hover:bg-purple-700 transition-all duration-200 shadow-lg hover:shadow-purple-500/25 hover:-translate-y-0.5">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<script>
function showSection(sectionName) {
    // Hide all sections
    document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.add('hidden');
    });
    
    // Remove active class from all nav items
    document.querySelectorAll('.settings-nav-item').forEach(item => {
        item.classList.remove('active', 'text-purple-700', 'bg-purple-50', 'border-purple-200');
        item.classList.add('text-gray-700', 'border-transparent');
    });
    
    // Show selected section
    document.getElementById(sectionName + '-section').classList.remove('hidden');
    
    // Add active class to clicked nav item
    event.target.classList.add('active', 'text-purple-700', 'bg-purple-50', 'border-purple-200');
    event.target.classList.remove('text-gray-700', 'border-transparent');
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function validatePassword() {
    const newPassword = document.getElementById('new_password').value;
    const requirements = {
        minLength: {{ password_requirements[user.role]['min_length'] }},
        requireUppercase: {{ 'true' if password_requirements[user.role]['require_uppercase'] else 'false' }},
        requireLowercase: {{ 'true' if password_requirements[user.role]['require_lowercase'] else 'false' }},
        requireNumbers: {{ 'true' if password_requirements[user.role]['require_numbers'] else 'false' }},
        requireSpecial: {{ 'true' if password_requirements[user.role]['require_special'] else 'false' }}
    };
    
    // Check length
    const lengthValid = newPassword.length >= requirements.minLength;
    updateValidationIcon('length-check', lengthValid);
    
    // Check uppercase
    if (requirements.requireUppercase) {
        const uppercaseValid = /[A-Z]/.test(newPassword);
        updateValidationIcon('uppercase-check', uppercaseValid);
    }
    
    // Check lowercase
    if (requirements.requireLowercase) {
        const lowercaseValid = /[a-z]/.test(newPassword);
        updateValidationIcon('lowercase-check', lowercaseValid);
    }
    
    // Check numbers
    if (requirements.requireNumbers) {
        const numbersValid = /[0-9]/.test(newPassword);
        updateValidationIcon('numbers-check', numbersValid);
    }
    
    // Check special characters
    if (requirements.requireSpecial) {
        const specialValid = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(newPassword);
        updateValidationIcon('special-check', specialValid);
    }
}

function updateValidationIcon(checkId, isValid) {
    const check = document.getElementById(checkId);
    if (!check) return;
    
    const icon = check.querySelector('i');
    const text = check.querySelector('span');
    
    if (isValid) {
        icon.classList.remove('fa-times', 'text-red-500');
        icon.classList.add('fa-check', 'text-green-500');
        text.classList.remove('text-red-600');
        text.classList.add('text-green-600');
    } else {
        icon.classList.remove('fa-check', 'text-green-500');
        icon.classList.add('fa-times', 'text-red-500');
        text.classList.remove('text-green-600');
        text.classList.add('text-red-600');
    }
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    
    function validatePasswordMatch() {
        if (newPassword.value !== confirmPassword.value) {
            confirmPassword.setCustomValidity('Passwords do not match');
        } else {
            confirmPassword.setCustomValidity('');
        }
    }
    
    newPassword.addEventListener('input', validatePasswordMatch);
    confirmPassword.addEventListener('input', validatePasswordMatch);
});
</script>
{% endblock %}
