{% extends "base.html" %}

{% block title %}First Login - Change Password{% endblock %}

{% block content %}
<!-- 
    ADMIN EXCEPTION LOGIC:
    The backend should check if session.username == 'admin' and skip first_login redirect
    This template should only render for non-admin users who need to change password
    
    Backend implementation should include:
    @app.before_request
    def check_first_login():
        if current_user.is_authenticated and current_user.username != 'admin':
            if current_user.requires_password_change:
                if request.endpoint not in ['first_login', 'logout']:
                    return redirect(url_for('first_login'))
-->
<div class="min-h-full bg-gray-900 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div>
            <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-yellow-900">
                <svg class="h-6 w-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
            </div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-white">
                Password Change Required
            </h2>
            <p class="mt-2 text-center text-sm text-gray-300">
                This is your first login. You must change your password to continue.
            </p>
        </div>

        <!-- Password Requirements -->
        <div class="bg-blue-900 border border-blue-700 rounded-lg p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-300">New Password Requirements</h3>
                    <div class="mt-2 text-sm text-blue-200">
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Minimum 12 characters</strong> in length</li>
                            <li><strong>At least 1 uppercase letter</strong> (A-Z)</li>
                            <li><strong>At least 1 lowercase letter</strong> (a-z)</li>
                            <li><strong>At least 1 number</strong> (0-9)</li>
                            <li><strong>At least 1 special character</strong> (!@#$%^&*)</li>
                            <li><strong>Cannot contain</strong> your username</li>
                            <li><strong>Cannot be</strong> a common password</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form class="mt-8 space-y-6" method="POST">
            {% if error %}
            <div class="bg-red-900 border border-red-700 text-red-300 px-4 py-3 rounded">
                {{ error }}
            </div>
            {% endif %}
            
            <div class="space-y-4">
                <!-- Current Password -->
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-300">
                        Current Password
                    </label>
                    <input 
                        id="current_password" 
                        name="current_password" 
                        type="password" 
                        required 
                        class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-600 placeholder-gray-400 text-white bg-gray-700 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                        placeholder="Enter your temporary password">
                </div>

                <!-- New Password -->
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-300">
                        New Password
                    </label>
                    <input 
                        id="new_password" 
                        name="new_password" 
                        type="password" 
                        required 
                        class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-600 placeholder-gray-400 text-white bg-gray-700 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                        placeholder="Enter your new password">
                    <div class="mt-2">
                        <!-- Password Strength Indicator -->
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="password-strength" class="bg-red-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="password-strength-text" class="mt-1 text-xs text-gray-400">Password strength: Weak</p>
                    </div>
                </div>

                <!-- Confirm New Password -->
                <div>
                    <label for="confirm_password" class="block text-sm font-medium text-gray-300">
                        Confirm New Password
                    </label>
                    <input 
                        id="confirm_password" 
                        name="confirm_password" 
                        type="password" 
                        required 
                        class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-600 placeholder-gray-400 text-white bg-gray-700 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" 
                        placeholder="Confirm your new password">
                    <p id="password-match" class="mt-1 text-xs text-gray-400"></p>
                </div>
            </div>

            <div>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-blue-500 group-hover:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
                        </svg>
                    </span>
                    Change Password and Continue
                </button>
            </div>

            <!-- Security Notice -->
            <div class="mt-6 p-4 bg-gray-800 border border-gray-700 rounded-md">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-300">
                            <strong>Security Notice:</strong> Your session will expire after 30 minutes of inactivity. 
                            Your password will expire in 90 days and you'll be required to change it again.
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Password strength checker
function checkPasswordStrength(password) {
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 12) score += 25;
    else feedback.push('At least 12 characters');
    
    // Uppercase check
    if (/[A-Z]/.test(password)) score += 25;
    else feedback.push('1 uppercase letter');
    
    // Lowercase check
    if (/[a-z]/.test(password)) score += 25;
    else feedback.push('1 lowercase letter');
    
    // Number check
    if (/[0-9]/.test(password)) score += 25;
    else feedback.push('1 number');
    
    // Special character check
    if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) score += 25;
    else feedback.push('1 special character');
    
    // Username check (basic)
    const username = '{{ session.username if session.username else "username" }}';
    if (password.toLowerCase().includes(username.toLowerCase())) {
        score -= 25;
        feedback.push('Cannot contain username');
    }
    
    return { score: Math.max(0, Math.min(100, score)), feedback };
}

function updatePasswordStrength() {
    const password = document.getElementById('new_password').value;
    const result = checkPasswordStrength(password);
    const strengthBar = document.getElementById('password-strength');
    const strengthText = document.getElementById('password-strength-text');
    
    // Update strength bar
    strengthBar.style.width = result.score + '%';
    
    // Update colors and text
    if (result.score < 40) {
        strengthBar.className = 'bg-red-600 h-2 rounded-full transition-all duration-300';
        strengthText.textContent = 'Password strength: Weak';
        strengthText.className = 'mt-1 text-xs text-red-400';
    } else if (result.score < 80) {
        strengthBar.className = 'bg-yellow-600 h-2 rounded-full transition-all duration-300';
        strengthText.textContent = 'Password strength: Medium';
        strengthText.className = 'mt-1 text-xs text-yellow-400';
    } else {
        strengthBar.className = 'bg-green-600 h-2 rounded-full transition-all duration-300';
        strengthText.textContent = 'Password strength: Strong';
        strengthText.className = 'mt-1 text-xs text-green-400';
    }
    
    // Show missing requirements
    if (result.feedback.length > 0 && password.length > 0) {
        strengthText.textContent += ' (Missing: ' + result.feedback.join(', ') + ')';
    }
}

function checkPasswordMatch() {
    const password = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchText = document.getElementById('password-match');
    
    if (confirmPassword.length > 0) {
        if (password === confirmPassword) {
            matchText.textContent = '✓ Passwords match';
            matchText.className = 'mt-1 text-xs text-green-400';
        } else {
            matchText.textContent = '✗ Passwords do not match';
            matchText.className = 'mt-1 text-xs text-red-400';
        }
    } else {
        matchText.textContent = '';
    }
}

// Event listeners
document.getElementById('new_password').addEventListener('input', updatePasswordStrength);
document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const password = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const result = checkPasswordStrength(password);
    
    if (result.score < 80) {
        e.preventDefault();
        alert('Password does not meet security requirements. Please choose a stronger password.');
        return false;
    }
    
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match.');
        return false;
    }
});
</script>
{% endblock %}
