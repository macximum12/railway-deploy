{% extends "base.html" %}

{% block title %}Edit Finding - Internal Audit Tracker{% endblock %}

{% block content %}
<div class="min-h-full">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="{{ url_for('findings') }}" class="mr-4 text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Edit Finding</h1>
                        <p class="mt-1 text-sm text-gray-500">
                            Update audit finding record #{{ finding.id if finding else 'NEW' }}
                        </p>
                    </div>
                </div>
                
                <!-- Status Badge -->
                {% if finding and finding.status %}
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                        {% if finding.status == 'Completed' %}
                            bg-green-100 text-green-800
                        {% elif finding.status == 'In-Progress' %}
                            bg-yellow-100 text-yellow-800
                        {% elif finding.status == 'Delayed' %}
                            bg-red-100 text-red-800
                        {% else %}
                            bg-gray-100 text-gray-800
                        {% endif %}">
                        {{ finding.status }}
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <form method="POST" class="space-y-8">
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-4 py-5 sm:p-6">
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Audit Reference -->
                        <div class="sm:col-span-2">
                            <label for="audit_reference" class="block text-sm font-medium text-gray-700">
                                Audit Reference *
                            </label>
                            <div class="mt-1">
                                <select id="audit_reference" name="audit_reference" required onchange="toggleAuditReport()"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Select audit reference</option>
                                    <option value="24-07" {{ 'selected' if finding and finding.audit_reference == '24-07' else '' }}>24-07</option>
                                    <option value="25-05" {{ 'selected' if finding and finding.audit_reference == '25-05' else '' }}>25-05</option>
                                    <option value="other" {{ 'selected' if finding and finding.audit_reference not in ['24-07', '25-05'] else '' }}>Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Audit Report -->
                        <div class="sm:col-span-2">
                            <label for="audit_report" class="block text-sm font-medium text-gray-700">
                                Audit Report *
                            </label>
                            <div class="mt-1" id="audit_report_select_div">
                                <select id="audit_report" name="audit_report" required
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Select audit report</option>
                                    <option value="Internal Audit Report" {{ 'selected' if finding and finding.audit_report == 'Internal Audit Report' else '' }}>Internal Audit Report</option>
                                    <option value="Compliance Review" {{ 'selected' if finding and finding.audit_report == 'Compliance Review' else '' }}>Compliance Review</option>
                                    <option value="Risk Assessment" {{ 'selected' if finding and finding.audit_report == 'Risk Assessment' else '' }}>Risk Assessment</option>
                                    <option value="Operational Audit" {{ 'selected' if finding and finding.audit_report == 'Operational Audit' else '' }}>Operational Audit</option>
                                    <option value="Financial Audit" {{ 'selected' if finding and finding.audit_report == 'Financial Audit' else '' }}>Financial Audit</option>
                                </select>
                            </div>
                            <div class="mt-1 hidden" id="audit_report_custom_div">
                                <input id="audit_report_custom" name="audit_report_custom" type="text"
                                       value="{{ finding.audit_report if finding and finding.audit_reference not in ['Internal Audit Report', 'Compliance Review', 'Risk Assessment', 'Operational Audit', 'Financial Audit'] else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="Enter custom audit report name">
                            </div>
                        </div>

                        <!-- Observations -->
                        <div class="sm:col-span-2">
                            <label for="observations" class="block text-sm font-medium text-gray-700">
                                Observations *
                            </label>
                            <div class="mt-1">
                                <textarea id="observations" name="observations" rows="3" required
                                          class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                          placeholder="Describe the key observations from the audit">{{ finding.observations if finding else '' }}</textarea>
                            </div>
                        </div>

                        <!-- Observation Details -->
                        <div class="sm:col-span-2">
                            <label for="observation_details" class="block text-sm font-medium text-gray-700">
                                Observation Details
                            </label>
                            <div class="mt-1">
                                <textarea id="observation_details" name="observation_details" rows="3"
                                          class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                          placeholder="Additional details about the observations (optional)">{{ finding.observation_details if finding else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Information -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Audit Information</h3>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Report Date -->
                        <div>
                            <label for="report_date" class="block text-sm font-medium text-gray-700">
                                Report Date
                            </label>
                            <div class="mt-1">
                                <input id="report_date" name="report_date" type="date"
                                       value="{{ finding.report_date.strftime('%Y-%m-%d') if finding and finding.report_date else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Priority -->
                        <div>
                            <label for="priority" class="block text-sm font-medium text-gray-700">
                                Priority
                            </label>
                            <div class="mt-1">
                                <select id="priority" name="priority"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Select priority</option>
                                    <option value="High" {{ 'selected' if finding and finding.priority == 'High' else '' }}>High</option>
                                    <option value="Medium" {{ 'selected' if finding and finding.priority == 'Medium' else '' }}>Medium</option>
                                    <option value="Low" {{ 'selected' if finding and finding.priority == 'Low' else '' }}>Low</option>
                                </select>
                            </div>
                        </div>

                        <!-- Recommendation -->
                        <div class="sm:col-span-2">
                            <label for="recommendation" class="block text-sm font-medium text-gray-700">
                                Recommendation
                            </label>
                            <div class="mt-1">
                                <textarea id="recommendation" name="recommendation" rows="3"
                                          class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                          placeholder="Recommended actions to address the findings">{{ finding.recommendation if finding else '' }}</textarea>
                            </div>
                        </div>

                        <!-- Management Response -->
                        <div class="sm:col-span-2">
                            <label for="management_response" class="block text-sm font-medium text-gray-700">
                                Management Response
                            </label>
                            <div class="mt-1">
                                <textarea id="management_response" name="management_response" rows="3"
                                          class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                          placeholder="Management's response to the findings">{{ finding.management_response if finding else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Implementation Details -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Implementation Details</h3>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Person Responsible -->
                        <div>
                            <label for="person_responsible" class="block text-sm font-medium text-gray-700">
                                Person Responsible
                            </label>
                            <div class="mt-1">
                                <input id="person_responsible" name="person_responsible" type="text"
                                       value="{{ finding.person_responsible if finding else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="Name of responsible person">
                            </div>
                        </div>

                        <!-- Department -->
                        <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">
                                Department
                            </label>
                            <div class="mt-1">
                                <input id="department" name="department" type="text"
                                       value="{{ finding.department if finding else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="Department name">
                            </div>
                        </div>

                        <!-- Status -->
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">
                                Status
                            </label>
                            <div class="mt-1">
                                <select id="status" name="status" onchange="toggleTargetDate(); updateStatusHistory()"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Select status</option>
                                    <option value="In-Progress" {{ 'selected' if finding and finding.status == 'In-Progress' else '' }}>In Progress</option>
                                    <option value="Completed" {{ 'selected' if finding and finding.status == 'Completed' else '' }}>Completed</option>
                                    <option value="Delayed" {{ 'selected' if finding and finding.status == 'Delayed' else '' }}>Delayed</option>
                                    <option value="Closed" {{ 'selected' if finding and finding.status == 'Closed' else '' }}>Closed</option>
                                </select>
                            </div>
                        </div>

                        <!-- Target Date -->
                        <div id="target_date_div">
                            <label for="target_date" class="block text-sm font-medium text-gray-700">
                                Target Date
                            </label>
                            <div class="mt-1">
                                <input id="target_date" name="target_date" type="date"
                                       value="{{ finding.target_date.strftime('%Y-%m-%d') if finding and finding.target_date else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Revised Target Date -->
                        <div>
                            <label for="revised_target_date" class="block text-sm font-medium text-gray-700">
                                Revised Target Date
                            </label>
                            <div class="mt-1">
                                <input id="revised_target_date" name="revised_target_date" type="date"
                                       value="{{ finding.revised_target_date.strftime('%Y-%m-%d') if finding and finding.revised_target_date else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>

                        <!-- Completion Date -->
                        <div>
                            <label for="completion_date" class="block text-sm font-medium text-gray-700">
                                Completion Date
                            </label>
                            <div class="mt-1">
                                <input id="completion_date" name="completion_date" type="date"
                                       value="{{ finding.completion_date.strftime('%Y-%m-%d') if finding and finding.completion_date else '' }}"
                                       class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Additional Information</h3>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <!-- Validated -->
                        <div>
                            <label for="validated" class="block text-sm font-medium text-gray-700">
                                Validated
                            </label>
                            <div class="mt-1">
                                <select id="validated" name="validated"
                                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Select validation status</option>
                                    <option value="Yes" {{ 'selected' if finding and finding.validated == 'Yes' else '' }}>Yes</option>
                                    <option value="No" {{ 'selected' if finding and finding.validated == 'No' else '' }}>No</option>
                                    <option value="Pending" {{ 'selected' if finding and finding.validated == 'Pending' else '' }}>Pending</option>
                                </select>
                            </div>
                        </div>

                        <!-- Testing Procedures -->
                        <div class="sm:col-span-2">
                            <label for="testing_procedures" class="block text-sm font-medium text-gray-700">
                                Testing Procedures
                            </label>
                            <div class="mt-1">
                                <textarea id="testing_procedures" name="testing_procedures" rows="3"
                                          class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                          placeholder="Testing procedures used to validate the finding">{{ finding.testing_procedures if finding else '' }}</textarea>
                            </div>
                        </div>

                        <!-- Comments -->
                        <div class="sm:col-span-2">
                            <label for="comments" class="block text-sm font-medium text-gray-700">
                                Comments
                            </label>
                            <div class="mt-1">
                                <textarea id="comments" name="comments" rows="3"
                                          class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                          placeholder="Additional comments or notes">{{ finding.comments if finding else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change History -->
            {% if finding and finding.id %}
            <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Change History</h3>
                    <div class="overflow-hidden bg-gray-50 rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="text-sm text-gray-500">
                                <p><strong>Created:</strong> {{ finding.created_date.strftime('%B %d, %Y at %I:%M %p') if finding.created_date else 'N/A' }}</p>
                                <p><strong>Last Modified:</strong> {{ finding.last_modified.strftime('%B %d, %Y at %I:%M %p') if finding.last_modified else 'N/A' }}</p>
                                {% if session.user_id %}
                                <p><strong>Last Updated By:</strong> {{ session.username if session.username else 'System' }}</p>
                                {% endif %}
                            </div>
                            
                            <!-- Status History -->
                            <div id="status-history" class="mt-4 space-y-2">
                                <h4 class="text-sm font-medium text-gray-900">Status Changes</h4>
                                <div class="text-xs text-gray-500">
                                    <!-- This would be populated from database in a real application -->
                                    <p>Status history will be tracked here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Form Actions -->
            <div class="flex justify-between">
                <div class="flex space-x-3">
                    {% if finding and finding.id %}
                    <button type="button" onclick="confirmDelete('{{ finding.id }}')" 
                            class="inline-flex items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <svg class="mr-2 -ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Delete Finding
                    </button>
                    {% endif %}
                </div>
                
                <div class="flex space-x-3">
                    <a href="{{ url_for('findings') }}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="mr-2 -ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancel
                    </a>
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="mr-2 -ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        {{ 'Update Finding' if finding else 'Save Finding' }}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function toggleAuditReport() {
    const auditRef = document.getElementById('audit_reference').value;
    const selectDiv = document.getElementById('audit_report_select_div');
    const customDiv = document.getElementById('audit_report_custom_div');
    const selectField = document.getElementById('audit_report');
    const customField = document.getElementById('audit_report_custom');
    
    if (auditRef === '24-07' || auditRef === '25-05') {
        selectDiv.classList.add('hidden');
        customDiv.classList.remove('hidden');
        selectField.required = false;
        customField.required = true;
    } else {
        selectDiv.classList.remove('hidden');
        customDiv.classList.add('hidden');
        selectField.required = true;
        customField.required = false;
    }
}

function toggleTargetDate() {
    const status = document.getElementById('status').value;
    const targetDateDiv = document.getElementById('target_date_div');
    const targetDateField = document.getElementById('target_date');
    const completionDateField = document.getElementById('completion_date');
    
    if (status === 'Completed') {
        targetDateDiv.style.opacity = '0.5';
        targetDateField.disabled = true;
        // Auto-set completion date to today if not already set
        if (!completionDateField.value) {
            completionDateField.valueAsDate = new Date();
        }
    } else {
        targetDateDiv.style.opacity = '1';
        targetDateField.disabled = false;
        if (status !== 'Completed') {
            completionDateField.value = '';
        }
    }
}

function updateStatusHistory() {
    const status = document.getElementById('status').value;
    const now = new Date().toLocaleString();
    
    // In a real application, this would update the database
    console.log(`Status changed to: ${status} at ${now}`);
}

function confirmDelete(findingId) {
    if (confirm('Are you sure you want to delete this finding? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/findings/${findingId}/delete`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_method';
        csrfInput.value = 'DELETE';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleAuditReport();
    toggleTargetDate();
    
    // Track changes for status history
    const originalStatus = document.getElementById('status').value;
    document.getElementById('status').addEventListener('change', function(e) {
        if (e.target.value !== originalStatus) {
            updateStatusHistory();
        }
    });
});

// Auto-save functionality (optional)
function autoSave() {
    const formData = new FormData(document.querySelector('form'));
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Store in localStorage as a backup
    localStorage.setItem('audit_finding_edit_draft', JSON.stringify(data));
}

// Set up auto-save on form change
document.querySelector('form').addEventListener('change', autoSave);

// Clear draft on successful submission
document.querySelector('form').addEventListener('submit', function() {
    localStorage.removeItem('audit_finding_edit_draft');
});

// Warn user about unsaved changes
window.addEventListener('beforeunload', function(e) {
    const formData = new FormData(document.querySelector('form'));
    let hasChanges = false;
    
    // Check if form has been modified
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.defaultValue !== input.value) {
            hasChanges = true;
        }
    });
    
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});
</script>
{% endblock %}
