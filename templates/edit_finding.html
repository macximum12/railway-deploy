{% extends "base.html" %}

{% block title %}Edit Finding - Audit Monitoring Dashboard{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Edit Audit Finding #{{ finding.id }}</h2>
        <a href="{{ url_for('index') }}" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
            Back to Dashboard
        </a>
    </div>

    <form method="POST" class="space-y-6">
        <!-- Basic Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Audit Reference</label>
                <select name="audit_reference" id="auditRefField" onchange="toggleAuditReport()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Audit Reference</option>
                    <option value="24-01" {{ 'selected' if finding.audit_reference == '24-01' else '' }}>24-01</option>
                    <option value="24-02" {{ 'selected' if finding.audit_reference == '24-02' else '' }}>24-02</option>
                    <option value="24-03" {{ 'selected' if finding.audit_reference == '24-03' else '' }}>24-03</option>
                    <option value="24-04" {{ 'selected' if finding.audit_reference == '24-04' else '' }}>24-04</option>
                    <option value="24-05" {{ 'selected' if finding.audit_reference == '24-05' else '' }}>24-05</option>
                    <option value="24-06" {{ 'selected' if finding.audit_reference == '24-06' else '' }}>24-06</option>
                    <option value="24-07" {{ 'selected' if finding.audit_reference == '24-07' else '' }}>24-07</option>
                    <option value="24-08" {{ 'selected' if finding.audit_reference == '24-08' else '' }}>24-08</option>
                    <option value="24-09" {{ 'selected' if finding.audit_reference == '24-09' else '' }}>24-09</option>
                    <option value="24-10" {{ 'selected' if finding.audit_reference == '24-10' else '' }}>24-10</option>
                    <option value="24-11" {{ 'selected' if finding.audit_reference == '24-11' else '' }}>24-11</option>
                    <option value="24-12" {{ 'selected' if finding.audit_reference == '24-12' else '' }}>24-12</option>
                    <option value="24-13" {{ 'selected' if finding.audit_reference == '24-13' else '' }}>24-13</option>
                    <option value="24-14" {{ 'selected' if finding.audit_reference == '24-14' else '' }}>24-14</option>
                    <option value="24-15" {{ 'selected' if finding.audit_reference == '24-15' else '' }}>24-15</option>
                    <option value="24-16" {{ 'selected' if finding.audit_reference == '24-16' else '' }}>24-16</option>
                    <option value="24-17" {{ 'selected' if finding.audit_reference == '24-17' else '' }}>24-17</option>
                    <option value="24-18" {{ 'selected' if finding.audit_reference == '24-18' else '' }}>24-18</option>
                    <option value="25-01" {{ 'selected' if finding.audit_reference == '25-01' else '' }}>25-01</option>
                    <option value="25-02" {{ 'selected' if finding.audit_reference == '25-02' else '' }}>25-02</option>
                    <option value="25-03" {{ 'selected' if finding.audit_reference == '25-03' else '' }}>25-03</option>
                    <option value="25-04" {{ 'selected' if finding.audit_reference == '25-04' else '' }}>25-04</option>
                    <option value="25-05" {{ 'selected' if finding.audit_reference == '25-05' else '' }}>25-05</option>
                    <option value="25-06" {{ 'selected' if finding.audit_reference == '25-06' else '' }}>25-06</option>
                    <option value="25-07" {{ 'selected' if finding.audit_reference == '25-07' else '' }}>25-07</option>
                    <option value="25-08" {{ 'selected' if finding.audit_reference == '25-08' else '' }}>25-08</option>
                    <option value="25-09" {{ 'selected' if finding.audit_reference == '25-09' else '' }}>25-09</option>
                    <option value="25-10" {{ 'selected' if finding.audit_reference == '25-10' else '' }}>25-10</option>
                    <option value="25-11" {{ 'selected' if finding.audit_reference == '25-11' else '' }}>25-11</option>
                    <option value="25-12" {{ 'selected' if finding.audit_reference == '25-12' else '' }}>25-12</option>
                    <option value="25-13" {{ 'selected' if finding.audit_reference == '25-13' else '' }}>25-13</option>
                    <option value="25-14" {{ 'selected' if finding.audit_reference == '25-14' else '' }}>25-14</option>
                    <option value="25-15" {{ 'selected' if finding.audit_reference == '25-15' else '' }}>25-15</option>
                    <option value="25-16" {{ 'selected' if finding.audit_reference == '25-16' else '' }}>25-16</option>
                    <option value="25-17" {{ 'selected' if finding.audit_reference == '25-17' else '' }}>25-17</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Audit Report</label>
                <select name="audit_report" id="auditReportField"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Audit Report</option>
                    <option value="Employee Masterfile Maintenance" {{ 'selected' if finding.audit_report == 'Employee Masterfile Maintenance' else '' }}>Employee Masterfile Maintenance</option>
                    <option value="Onboarding" {{ 'selected' if finding.audit_report == 'Onboarding' else '' }}>Onboarding</option>
                    <option value="Timekeeping" {{ 'selected' if finding.audit_report == 'Timekeeping' else '' }}>Timekeeping</option>
                    <option value="Offboarding" {{ 'selected' if finding.audit_report == 'Offboarding' else '' }}>Offboarding</option>
                    <option value="Payroll" {{ 'selected' if finding.audit_report == 'Payroll' else '' }}>Payroll</option>
                    <option value="Benefits Administration" {{ 'selected' if finding.audit_report == 'Benefits Administration' else '' }}>Benefits Administration</option>
                    <option value="Client Operations Audit" {{ 'selected' if finding.audit_report == 'Client Operations Audit' else '' }}>Client Operations Audit</option>
                    <option value="Contractual Compliance Review" {{ 'selected' if finding.audit_report == 'Contractual Compliance Review' else '' }}>Contractual Compliance Review</option>
                    <option value="Ubiquity and Client Systems Offboarding" {{ 'selected' if finding.audit_report == 'Ubiquity and Client Systems Offboarding' else '' }}>Ubiquity and Client Systems Offboarding</option>
                    <option value="Physical Access/Security" {{ 'selected' if finding.audit_report == 'Physical Access/Security' else '' }}>Physical Access/Security</option>
                    <option value="Information Technology Asset Management" {{ 'selected' if finding.audit_report == 'Information Technology Asset Management' else '' }}>Information Technology Asset Management</option>
                    <option value="Fixed Asset Management (Non-IT)" {{ 'selected' if finding.audit_report == 'Fixed Asset Management (Non-IT)' else '' }}>Fixed Asset Management (Non-IT)</option>
                    <option value="Information Security" {{ 'selected' if finding.audit_report == 'Information Security' else '' }}>Information Security</option>
                    <option value="Procurement" {{ 'selected' if finding.audit_report == 'Procurement' else '' }}>Procurement</option>
                    <option value="IT General Controls Review" {{ 'selected' if finding.audit_report == 'IT General Controls Review' else '' }}>IT General Controls Review</option>
                    <option value="Training (Learning Services)" {{ 'selected' if finding.audit_report == 'Training (Learning Services)' else '' }}>Training (Learning Services)</option>
                    <option value="Privacy Program" {{ 'selected' if finding.audit_report == 'Privacy Program' else '' }}>Privacy Program</option>
                    <option value="Workforce Management" {{ 'selected' if finding.audit_report == 'Workforce Management' else '' }}>Workforce Management</option>
                    <option value="Employee Onboarding" {{ 'selected' if finding.audit_report == 'Employee Onboarding' else '' }}>Employee Onboarding</option>
                    <option value="Employee Timekeeping" {{ 'selected' if finding.audit_report == 'Employee Timekeeping' else '' }}>Employee Timekeeping</option>
                    <option value="Employee Offboarding" {{ 'selected' if finding.audit_report == 'Employee Offboarding' else '' }}>Employee Offboarding</option>
                    <option value="Contract Compliance Review" {{ 'selected' if finding.audit_report == 'Contract Compliance Review' else '' }}>Contract Compliance Review</option>
                    <option value="Fixed Asset Management" {{ 'selected' if finding.audit_report == 'Fixed Asset Management' else '' }}>Fixed Asset Management</option>
                    <option value="Disbursement" {{ 'selected' if finding.audit_report == 'Disbursement' else '' }}>Disbursement</option>
                    <option value="Workforce Management: Delivery (Planning/Scheduling)" {{ 'selected' if finding.audit_report == 'Workforce Management: Delivery (Planning/Scheduling)' else '' }}>Workforce Management: Delivery (Planning/Scheduling)</option>
                    <option value="IT Audits: Application Controls Review (Payroll)" {{ 'selected' if finding.audit_report == 'IT Audits: Application Controls Review (Payroll)' else '' }}>IT Audits: Application Controls Review (Payroll)</option>
                    <option value="IT Audits: Application Controls Review (In house tools)" {{ 'selected' if finding.audit_report == 'IT Audits: Application Controls Review (In house tools)' else '' }}>IT Audits: Application Controls Review (In house tools)</option>
                    <option value="IT Audits: IT Operations (End User Support)" {{ 'selected' if finding.audit_report == 'IT Audits: IT Operations (End User Support)' else '' }}>IT Audits: IT Operations (End User Support)</option>
                    <option value="IT Audits: IT Onboarding and Sunset (Programs)" {{ 'selected' if finding.audit_report == 'IT Audits: IT Onboarding and Sunset (Programs)' else '' }}>IT Audits: IT Onboarding and Sunset (Programs)</option>
                    <option value="Cyber Security Audit" {{ 'selected' if finding.audit_report == 'Cyber Security Audit' else '' }}>Cyber Security Audit</option>
                    <option value="Management Requests: Special Audits, Investigations, etc." {{ 'selected' if finding.audit_report == 'Management Requests: Special Audits, Investigations, etc.' else '' }}>Management Requests: Special Audits, Investigations, etc.</option>
                </select>
                <input type="text" name="audit_report_custom" id="auditReportCustomField" value="{{ finding.audit_report if finding.audit_reference in ['24-07', '25-05'] else '' }}" placeholder="Enter custom audit report name" style="display: none;"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- Observations -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Observations</label>
                <textarea name="observations" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ finding.observations or '' }}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Observation Details</label>
                <textarea name="observation_details" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ finding.observation_details or '' }}</textarea>
            </div>
        </div>

        <!-- Dates and Priority -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Report Date</label>
                <input type="date" name="report_date" value="{{ finding.report_date or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select name="priority" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Priority</option>
                    <option value="HIGH" {{ 'selected' if finding.priority == 'HIGH' }}>HIGH</option>
                    <option value="MEDIUM" {{ 'selected' if finding.priority == 'MEDIUM' }}>MEDIUM</option>
                    <option value="LOW" {{ 'selected' if finding.priority == 'LOW' }}>LOW</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select name="status" id="statusField" onchange="toggleCompletionDate()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Status</option>
                    <option value="Completed" {{ 'selected' if finding.status == 'Completed' }}>Completed</option>
                    <option value="In-Progress" {{ 'selected' if finding.status == 'In-Progress' }}>In-Progress</option>
                    <option value="Delayed" {{ 'selected' if finding.status == 'Delayed' }}>Delayed</option>
                    <option value="Closed" {{ 'selected' if finding.status == 'Closed' }}>Closed</option>
                </select>
            </div>
        </div>

        <!-- Recommendation and Response -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Recommendation</label>
                <textarea name="recommendation" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ finding.recommendation or '' }}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Management Response</label>
                <textarea name="management_response" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ finding.management_response or '' }}</textarea>
            </div>
        </div>

        <!-- Target Dates -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Target Date</label>
                <input type="date" name="target_date" value="{{ finding.target_date or '' }}" disabled
                       class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-400 cursor-not-allowed disabled:bg-gray-100 disabled:text-gray-400">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Revised Target Date</label>
                <input type="date" name="revised_target_date" value="{{ finding.revised_target_date or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" id="completionDateLabel">
                    Completion Date
                    <span class="text-red-500 hidden" id="requiredIndicator">*</span>
                </label>
                <input type="date" name="completion_date" id="completionDateField" value="{{ finding.completion_date or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
            </div>
        </div>

        <!-- Responsibility -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Person Responsible</label>
                <input type="text" name="person_responsible" value="{{ finding.person_responsible or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                <input type="text" name="department" value="{{ finding.department or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Validated</label>
                <select name="validated" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Validation</option>
                    <option value="YES" {{ 'selected' if finding.validated == 'YES' }}>YES</option>
                    <option value="NO" {{ 'selected' if finding.validated == 'NO' }}>NO</option>
                </select>
            </div>
        </div>

        <!-- Testing and Comments -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Testing Procedures</label>
                <textarea name="testing_procedures" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ finding.testing_procedures or '' }}</textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Comments</label>
                <textarea name="comments" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ finding.comments or '' }}</textarea>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('index') }}" 
               class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Update Finding
            </button>
        </div>
    </form>
</div>

<!-- Record Information -->
<div class="bg-gray-50 rounded-lg p-4 mt-6">
    <h3 class="text-sm font-medium text-gray-700 mb-2">Record Information</h3>
    <div class="text-xs text-gray-500 space-y-1">
        <p><strong>Created:</strong> {{ finding.created_at }}</p>
        <p><strong>Last Updated:</strong> {{ finding.updated_at or 'Never' }}</p>
    </div>
</div>

<script>
function toggleCompletionDate() {
    const statusField = document.getElementById('statusField');
    const completionDateField = document.getElementById('completionDateField');
    const requiredIndicator = document.getElementById('requiredIndicator');
    const completionDateLabel = document.getElementById('completionDateLabel');
    
    if (statusField.value === 'Completed') {
        // Enable the completion date field for completed status
        completionDateField.disabled = false;
        completionDateField.required = true;
        completionDateField.className = "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500";
        
        // Show required indicator
        requiredIndicator.classList.remove('hidden');
        
        // Update label styling
        completionDateLabel.classList.remove('text-gray-400');
        completionDateLabel.classList.add('text-gray-700');
    } else {
        // Disable the completion date field for other statuses
        completionDateField.disabled = true;
        completionDateField.required = false;
        
        // Don't clear the value in edit mode - preserve existing data
        completionDateField.className = "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed";
        
        // Hide required indicator
        requiredIndicator.classList.add('hidden');
        
        // Update label styling to gray
        completionDateLabel.classList.remove('text-gray-700');
        completionDateLabel.classList.add('text-gray-400');
    }
}

function toggleAuditReport() {
    const auditRefField = document.getElementById('auditRefField');
    const auditReportField = document.getElementById('auditReportField');
    const auditReportCustomField = document.getElementById('auditReportCustomField');
    
    // Define the mapping between audit references and reports
    const auditMapping = {
        '24-01': 'Employee Masterfile Maintenance',
        '24-02': 'Onboarding',
        '24-03': 'Timekeeping',
        '24-04': 'Offboarding',
        '24-05': 'Payroll',
        '24-06': 'Benefits Administration',
        '24-08': 'Contractual Compliance Review',
        '24-09': 'Ubiquity and Client Systems Offboarding',
        '24-10': 'Physical Access/Security',
        '24-11': 'Information Technology Asset Management',
        '24-12': 'Fixed Asset Management (Non-IT)',
        '24-13': 'Information Security',
        '24-14': 'Procurement',
        '24-15': 'IT General Controls Review',
        '24-16': 'Training (Learning Services)',
        '24-17': 'Privacy Program',
        '24-18': 'Workforce Management',
        '25-01': 'Employee Onboarding',
        '25-02': 'Employee Timekeeping',
        '25-03': 'Employee Offboarding',
        '25-04': 'Payroll',
        '25-06': 'Contract Compliance Review',
        '25-07': 'Information Technology Asset Management',
        '25-08': 'Fixed Asset Management',
        '25-09': 'Disbursement',
        '25-10': 'Privacy Program',
        '25-11': 'Workforce Management: Delivery (Planning/Scheduling)',
        '25-12': 'IT Audits: Application Controls Review (Payroll)',
        '25-13': 'IT Audits: Application Controls Review (In house tools)',
        '25-14': 'IT Audits: IT Operations (End User Support)',
        '25-15': 'IT Audits: IT Onboarding and Sunset (Programs)',
        '25-16': 'Cyber Security Audit',
        '25-17': 'Management Requests: Special Audits, Investigations, etc.'
    };
    
    // Check if selected audit reference is 24-07 or 25-05 (custom input needed)
    if (auditRefField.value === '24-07' || auditRefField.value === '25-05') {
        // Hide dropdown and show custom input field
        auditReportField.style.display = 'none';
        auditReportCustomField.style.display = 'block';
        auditReportField.required = false;
        auditReportCustomField.required = true;
        
        // In edit mode, don't clear the custom field if it has a value
        if (!auditReportCustomField.value) {
            auditReportField.value = ''; // Only clear dropdown if custom field is empty
        }
    } else if (auditRefField.value && auditMapping[auditRefField.value]) {
        // Auto-populate from mapping for all other references
        auditReportField.style.display = 'block';
        auditReportCustomField.style.display = 'none';
        auditReportField.required = true;
        auditReportCustomField.required = false;
        
        // Set the corresponding audit report value
        auditReportField.value = auditMapping[auditRefField.value];
        
        // In edit mode, clear custom field only if we're auto-populating
        auditReportCustomField.value = '';
    } else {
        // Show dropdown for empty selection
        auditReportField.style.display = 'block';
        auditReportCustomField.style.display = 'none';
        auditReportField.required = true;
        auditReportCustomField.required = false;
        
        // In edit mode, don't clear fields unless we're sure
        if (!auditRefField.value) {
            auditReportField.value = '';
            auditReportCustomField.value = '';
        }
    }
}

// Initialize the field state on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleCompletionDate();
    toggleAuditReport();
});
</script>
{% endblock %}
