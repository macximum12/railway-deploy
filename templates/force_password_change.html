{% extends "base.html" %}

{% block title %}Change Temporary Password - Internal Audit Tracker{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="bg-gradient-to-r from-yellow-500 to-orange-600 p-4 rounded-full w-20 h-20 mx-auto mb-6 shadow-lg">
                <i class="fas fa-key text-white text-3xl mt-2"></i>
            </div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">
                Password Change Required
            </h2>
            <p class="mt-2 text-gray-600">
                You must change your temporary password before continuing
            </p>
        </div>

        <!-- Password Requirements Info -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-600 mt-1 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-yellow-800">Password Requirements</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>As a <strong>{{ user.role.title() }}</strong>, your password must be at least <strong>{{ password_requirements[user.role]['min_length'] }} characters</strong> long.</p>
                        {% if password_requirements[user.role]['require_uppercase'] %}
                        <p class="mt-1">• Must contain uppercase letters (A-Z)</p>
                        {% endif %}
                        {% if password_requirements[user.role]['require_lowercase'] %}
                        <p class="mt-1">• Must contain lowercase letters (a-z)</p>
                        {% endif %}
                        {% if password_requirements[user.role]['require_numbers'] %}
                        <p class="mt-1">• Must contain numbers (0-9)</p>
                        {% endif %}
                        {% if password_requirements[user.role]['require_special'] %}
                        <p class="mt-1">• Must contain special characters (!@#$%^&*)</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Change Form -->
        <div class="bg-white shadow-2xl rounded-2xl p-8 border border-gray-100">
            <form method="POST" class="space-y-6">
                <!-- Current Password -->
                <div>
                    <label for="current_password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-unlock text-gray-500 mr-2"></i>Current Temporary Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="current_password" 
                            name="current_password" 
                            required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-200 pr-12"
                            placeholder="Enter your temporary password"
                            oninput="validatePasswordRequirements()"
                        >
                        <button 
                            type="button" 
                            onclick="togglePassword('current_password', this)" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- New Password -->
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key text-gray-500 mr-2"></i>New Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="new_password" 
                            name="new_password" 
                            required 
                            minlength="{{ password_requirements[user.role]['min_length'] }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-200 pr-12"
                            placeholder="Enter new password (min {{ password_requirements[user.role]['min_length'] }} characters)"
                            oninput="validatePasswordRequirements()"
                        >
                        <button 
                            type="button" 
                            onclick="togglePassword('new_password', this)" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <div class="space-y-1">
                            <div id="length-check" class="flex items-center space-x-1">
                                <i class="fas fa-times text-red-500 text-xs"></i>
                                <span class="text-xs text-red-600">{{ password_requirements[user.role]['min_length'] }}+ characters</span>
                            </div>
                            {% if password_requirements[user.role]['require_uppercase'] %}
                            <div id="uppercase-check" class="flex items-center space-x-1">
                                <i class="fas fa-times text-red-500 text-xs"></i>
                                <span class="text-xs text-red-600">Uppercase letter (A-Z)</span>
                            </div>
                            {% endif %}
                            {% if password_requirements[user.role]['require_lowercase'] %}
                            <div id="lowercase-check" class="flex items-center space-x-1">
                                <i class="fas fa-times text-red-500 text-xs"></i>
                                <span class="text-xs text-red-600">Lowercase letter (a-z)</span>
                            </div>
                            {% endif %}
                            {% if password_requirements[user.role]['require_numbers'] %}
                            <div id="numbers-check" class="flex items-center space-x-1">
                                <i class="fas fa-times text-red-500 text-xs"></i>
                                <span class="text-xs text-red-600">Number (0-9)</span>
                            </div>
                            {% endif %}
                            {% if password_requirements[user.role]['require_special'] %}
                            <div id="special-check" class="flex items-center space-x-2">
                                <i class="fas fa-times text-red-500 text-xs"></i>
                                <span class="text-xs text-red-600">Special character (!@#$%^&*)</span>
                            </div>
                            {% endif %}
                            <div id="reuse-check" class="flex items-center space-x-2">
                                <i class="fas fa-times text-red-500 text-xs"></i>
                                <span class="text-xs text-red-600">Different from current password</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div>
                    <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-check-double text-gray-500 mr-2"></i>Confirm New Password
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="confirm_password" 
                            name="confirm_password" 
                            required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-200 pr-12"
                            placeholder="Confirm your new password"
                            oninput="validatePasswordMatch()"
                        >
                        <button 
                            type="button" 
                            onclick="togglePassword('confirm_password', this)" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div id="match-message" class="mt-2 text-sm" style="display: none;"></div>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submit-btn"
                    disabled
                    class="w-full bg-gradient-to-r from-yellow-600 to-orange-600 text-white font-semibold py-3 px-6 rounded-lg hover:from-yellow-700 hover:to-orange-700 focus:ring-4 focus:ring-yellow-500/50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                >
                    <i class="fas fa-save mr-2"></i>Change Password
                </button>
            </form>
        </div>

        <!-- Security Note -->
        <div class="text-center">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-center">
                    <i class="fas fa-shield-alt text-red-600 mr-2"></i>
                    <p class="text-sm text-red-700 font-medium">
                        You cannot access the system until you change your temporary password
                    </p>
                </div>
            </div>
            
            <!-- Emergency Reset Link -->
            <div class="mt-4">
                <p class="text-xs text-gray-500 mb-2">Having trouble? Need help?</p>
                <a href="{{ url_for('reset_password_loop') }}" 
                   class="text-xs text-blue-600 hover:text-blue-800 underline">
                    Reset password change session
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function validatePasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const currentPassword = document.getElementById('current_password').value;
    const matchMessage = document.getElementById('match-message');
    const submitBtn = document.getElementById('submit-btn');
    
    // Check if all requirements are met
    const requirements = {
        length: {{ password_requirements[user.role]['min_length'] }},
        uppercase: {{ 'true' if password_requirements[user.role]['require_uppercase'] else 'false' }},
        lowercase: {{ 'true' if password_requirements[user.role]['require_lowercase'] else 'false' }},
        numbers: {{ 'true' if password_requirements[user.role]['require_numbers'] else 'false' }},
        special: {{ 'true' if password_requirements[user.role]['require_special'] else 'false' }}
    };
    
    let allRequirementsMet = newPassword.length >= requirements.length;
    
    if (requirements.uppercase) {
        allRequirementsMet = allRequirementsMet && /[A-Z]/.test(newPassword);
    }
    if (requirements.lowercase) {
        allRequirementsMet = allRequirementsMet && /[a-z]/.test(newPassword);
    }
    if (requirements.numbers) {
        allRequirementsMet = allRequirementsMet && /[0-9]/.test(newPassword);
    }
    if (requirements.special) {
        allRequirementsMet = allRequirementsMet && /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);
    }
    
    // Check password reuse - new password must be different from current password
    const isDifferentFromCurrent = newPassword !== currentPassword || newPassword.length === 0;
    allRequirementsMet = allRequirementsMet && isDifferentFromCurrent;
    
    // Check password match
    if (confirmPassword.length > 0) {
        matchMessage.style.display = 'block';
        if (newPassword === confirmPassword) {
            matchMessage.innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i><span class="text-green-600">Passwords match</span>';
        } else {
            matchMessage.innerHTML = '<i class="fas fa-times text-red-500 mr-1"></i><span class="text-red-600">Passwords do not match</span>';
        }
    } else {
        matchMessage.style.display = 'none';
    }
    
    // Enable/disable submit button
    const passwordsMatch = newPassword === confirmPassword && confirmPassword.length > 0;
    const canSubmit = allRequirementsMet && passwordsMatch;
    
    submitBtn.disabled = !canSubmit;
    if (canSubmit) {
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function validatePasswordRequirements() {
    const password = document.getElementById('new_password').value;
    const requirements = {
        length: {{ password_requirements[user.role]['min_length'] }},
        uppercase: {{ 'true' if password_requirements[user.role]['require_uppercase'] else 'false' }},
        lowercase: {{ 'true' if password_requirements[user.role]['require_lowercase'] else 'false' }},
        numbers: {{ 'true' if password_requirements[user.role]['require_numbers'] else 'false' }},
        special: {{ 'true' if password_requirements[user.role]['require_special'] else 'false' }}
    };
    
    // Check length
    updateCheckElement('length-check', password.length >= requirements.length);
    
    // Check uppercase
    if (requirements.uppercase) {
        updateCheckElement('uppercase-check', /[A-Z]/.test(password));
    }
    
    // Check lowercase
    if (requirements.lowercase) {
        updateCheckElement('lowercase-check', /[a-z]/.test(password));
    }
    
    // Check numbers
    if (requirements.numbers) {
        updateCheckElement('numbers-check', /[0-9]/.test(password));
    }
    
    // Check special characters
    if (requirements.special) {
        updateCheckElement('special-check', /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password));
    }
    
    // Check password reuse - ensure new password is different from current password
    const currentPassword = document.getElementById('current_password').value;
    const isDifferentFromCurrent = password !== currentPassword || password.length === 0;
    updateCheckElement('reuse-check', isDifferentFromCurrent);
    
    // Also check password match
    validatePasswordMatch();
}

function updateCheckElement(elementId, isValid) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const icon = element.querySelector('i');
    const text = element.querySelector('span');
    
    if (isValid) {
        icon.classList.remove('fa-times', 'text-red-500');
        icon.classList.add('fa-check', 'text-green-500');
        text.classList.remove('text-red-600');
        text.classList.add('text-green-600');
    } else {
        icon.classList.remove('fa-check', 'text-green-500');
        icon.classList.add('fa-times', 'text-red-500');
        text.classList.remove('text-green-600');
        text.classList.add('text-red-600');
    }
}

// Initialize validation on page load
document.addEventListener('DOMContentLoaded', function() {
    validatePasswordRequirements();
});
</script>
{% endblock %}
